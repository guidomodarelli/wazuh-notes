---
import { getCollection } from 'astro:content';
import Cards from './Cards.astro';
import SearchWithDropdown, { type DropdownButton } from './SearchWithDropdown.astro';
import { type Props as CardProps } from './Card.astro';

const faqs = await getCollection('faqs');

const cards: CardProps[] = [
  ...faqs.map(({ data, slug, collection }) => {
    return {
      title: data.title,
      description: data.description,
      btnHref: `/content/faqs/${slug}`,
      tags: data.tags,
      type: collection,
      slug,
    };
  }),
];

const dropdownButtons: DropdownButton[] = [
  {
    key: 'all',
    label: 'All',
  },
  {
    key: 'apps',
    label: 'Apps',
  },
  {
    key: 'faqs',
    label: 'FAQs',
  },
];
---

<script>
  import type { DropdownButton } from './SearchWithDropdown.astro';

  const includesText = (searchQuery: string) => {
    return (text?: string) => text?.toLowerCase().includes(searchQuery?.toLowerCase());
  };

  const showDropdown = (dropdown: HTMLElement) => {
    dropdown.classList.remove('hidden');
    dropdown.classList.add('block');
  };

  const hideDropdown = (dropdown: HTMLElement) => {
    dropdown.classList.remove('block');
    dropdown.classList.add('hidden');
  };

  const initializeDropdownListeners = () => {
    const dropdownButton = document.querySelector('#dropdown-button') as HTMLElement;
    const dropdown = document.querySelector('#dropdown') as HTMLElement;
    const dropdownButtons = document.querySelectorAll('[data-dropdown-button]') as NodeListOf<HTMLElement>;

    const toggleDropdownVisibility = () => {
      if (dropdown.classList.contains('hidden')) {
        showDropdown(dropdown);
      } else {
        hideDropdown(dropdown);
      }
    };

    const filterCardsByType = (dropdownButtonData: DropdownButton) => {
      const cards = document.querySelectorAll('[data-card]') as NodeListOf<HTMLElement>;
      cards.forEach((card) => {
        const shouldShowCard = (cardType: string | undefined, key: string): boolean => {
          return key === 'all' || cardType === key;
        };

        cards.forEach((card) => {
          const cardType = card.dataset.cardType;
          if (shouldShowCard(cardType, dropdownButtonData.key)) {
            delete card.dataset.cardDontShowOnType;
          } else {
            card.dataset.cardDontShowOnType = '';
          }
        });
      });
    };

    const handleDropdownButtonClick = (button: HTMLElement) => {
      button.addEventListener('click', () => {
        const dropdownButtonData = JSON.parse(button.dataset.dropdownButton ?? '{}') as DropdownButton;
        filterCardsByType(dropdownButtonData);
        hideDropdown(dropdown);
      });
    };

    const handleDocumentClick = (event: MouseEvent) => {
      if (!dropdown.contains(event.target as Node) && !dropdownButton.contains(event.target as Node)) {
        hideDropdown(dropdown);
      }
    };

    dropdownButton.addEventListener('click', toggleDropdownVisibility);
    dropdownButtons.forEach(handleDropdownButtonClick);
    document.addEventListener('click', handleDocumentClick);
  };

  const setupSearch = () => {
    const searchForm = document.querySelector('#search-dropdown-form') as HTMLFormElement;

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
    });

    const searchInput = document.querySelector('#search-dropdown') as HTMLInputElement;
    const cards = document.querySelectorAll('[data-card]') as NodeListOf<HTMLElement>;

    searchInput.focus();

    searchInput.addEventListener('input', (event) => {
      const inputText = (event?.target as HTMLInputElement)?.value;
      cards.forEach((card) => {
        const { title, description, tags, type } = JSON.parse(
          card.dataset.card ?? '{}',
        ) as import('./Card.astro').Props;
        if (inputText) {
          if (
            includesText(inputText)(title) ||
            includesText(inputText)(description) ||
            tags?.some(includesText(inputText))
          ) {
            delete card.dataset.cardDontMatchSearch;
          } else {
            card.dataset.cardDontMatchSearch = '';
          }
        } else {
          delete card.dataset.cardDontMatchSearch;
        }
      });
    });

    const searchQuery = new URLSearchParams(window.location.search).get('q');
    if (searchQuery) {
      searchInput.value = searchQuery;
      searchInput.dispatchEvent(new Event('input'));
    }
  };

  // Execute setupSearch when the page is loaded or when the user returns to the history
  window.addEventListener('DOMContentLoaded', () => {
    setupSearch();
    initializeDropdownListeners();
  });
  window.addEventListener('popstate', () => {
    location.reload();
  });
</script>

<SearchWithDropdown class="mb-6" dropdownButtons={dropdownButtons} />
<Cards cards={cards} />
